<!doctype html>
<html lang="en">
<head>
<title>Scripting with Scala CLI &amp; Os-lib</title>
<!-- 2022-10-12 Wed 23:51 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="benkio">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style>body { margin-bottom: 0px; }</style><script>
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script><link rel="shortcut icon" href="../../images/favicon.ico" type="image/x-icon">
<link rel="icon" href="../../images/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link rel="stylesheet" href="../css/main.css">
<link rel="stylesheet" href="../css/blog.css">
<link rel="stylesheet" href="../css/article.css">
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-3 col-md-push-9"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#navbar">Blog</a></li>
<li><a href="#Article">Scripting with Scala CLI &amp; Os-lib</a>
<ul class="nav">
<li><a href="#ArticleAbstract">Abstract</a></li>
<li><a href="#ArticleContent">Use Cases &amp; Motivations</a></li>
<li><a href="#sec-">Insert Script Dependency</a></li>
<li><a href="#sec-">Movie Convertion Script</a>
<ul class="nav">
<li><a href="#sec-">File Paths</a></li>
<li><a href="#sec-">Script Entry Point</a></li>
<li><a href="#sec-">FFMPEG Command</a></li>
<li><a href="#sec-">Split Command</a></li>
<li><a href="#sec-">Remove Command</a></li>
<li><a href="#sec-">List Files</a></li>
<li><a href="#sec-">Move Files</a></li>
<li><a href="#sec-">Final Cleanup</a></li>
<li><a href="#sec-">Parallel Collection</a></li>
<li><a href="#sec-">Testing</a></li>
</ul>
</li>
<li><a href="#sec-">Youtube to GIF Script</a></li>
<li><a href="#ArticleConclusions">Conclusions</a></li>
<li><a href="#sec-">References</a></li>
</ul>
</li>
<li><a href="#ShareButtons">Share Buttons</a></li>
</ul>
</div>
</nav>
</div><div class="col-md-9 col-md-pull-3"><h1 class="title">Scripting with Scala CLI &amp; Os-lib</h1>

<div id="outline-container-navbar" class="outline-2 text-center navbar navbar-inverse navbar-fixed-top">
<h2 id="navbar"><a id="sec-" name="sec-"></a>Blog</h2>
<div class="outline-text-2" id="text-navbar">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#collapsableNavbar">
  <span class="icon-bar"></span>
  <span class="icon-bar"></span>
  <span class="icon-bar"></span>
</button>
<a title="Home" href="../blog.html"><h1 id="navbarTitle" class="navbar-text">Blog</h1></a>
<div class="collapse navbar-collapse" id="collapsableNavbar">
  <ul class="nav navbar-nav">
    <li><a title="Home" href="../index.html"><i class="fas fa-home fa-3x" aria-hidden="true"></i></a></li>
    <li><a title="Article List" href="../articleList.html" class="navbar-text h3">Article List</a></li>
<li><a title="Book List" href="../bookList.html" class="navbar-text h3">Book List</a></li>
    <li><a title="Album List" href="../albumList.html" class="navbar-text h3">Album List</a></li>
    <li><a title="Note Trainer" href="../NoteTrainer/NoteTrainer.html" class="navbar-text h3">Note Trainer</a></li>
  </ul>
</div>
</div>
</div>

<div id="outline-container-Article" class="outline-2">
<h2 id="Article"><a id="sec-" name="sec-"></a>Scripting with Scala CLI &amp; Os-lib</h2>
<div class="outline-text-2" id="text-Article">
<p>
<b>Created: <span class="timestamp-wrapper"><span class="timestamp">&lt;2022-10-08 Sat&gt;</span></span></b>
</p>
</div>
<div id="outline-container-ArticleAbstract" class="outline-3">
<h3 id="ArticleAbstract"><a id="sec-" name="sec-"></a>Abstract</h3>
<div class="outline-text-3" id="text-ArticleAbstract">
<p>
In this article I will show how I refactored some existing scripts
written in <a href="https://scala-cli.virtuslab.org/">scala-cli</a> using the <a href="https://github.com/com-lihaoyi/os-lib">os-lib</a>.
</p>
</div>
</div>

<div id="outline-container-ArticleContent" class="outline-3">
<h3 id="ArticleContent"><a id="sec-" name="sec-"></a>Use Cases &amp; Motivations</h3>
<div class="outline-text-3" id="text-ArticleContent">
<p>
Everyone has his own scripts for various tasks and I'm no exception.
At the time of writing I have 2:
</p>
<ul class="org-ul">
<li>One for converting movies to a format compatible with my mom's
TV. Movies needs to be in Xvid, 720p, a specific bit rate, mp3
audio track, and be not bigger then 1GB (if so it must be
splitted). I discovered this by trial and error.
</li>
<li>One for generating GIF (muted video chunks with subtitles, to be
precise) staring from YouTube links.

<p>
For these task I rely on <a href="https://scala-cli.virtuslab.org/">scala-cli</a>, <code>ffmpeg</code>, <code>yt-dlp</code> and classic
Unix commands such as <code>rm</code> and <code>mv</code>.
</p>

<p>
Everything works as expected and anyone with a little trace of
intelligence would keep the situation as it is. At least until
something goes wrong. However, being a Scala engineer, I heard about
"the lihaoyi ecosystem" several times and I've never had a chance
to play with it. Plus, the above scripts use the <a href="https://www.scala-lang.org/api/2.13.x/scala/sys/process/index.html">sys.process._</a>
package and I'm not really super fan of it. So I thought: "why
just I don't refactor the scripts using the <a href="https://github.com/com-lihaoyi/os-lib">os-lib</a>?". This way I can
both the goals of getting rid of the <a href="https://www.scala-lang.org/api/2.13.x/scala/sys/process/index.html">sys.process._</a> and try something
from lihaoyi.
</p>

<p>
Moreover, apart from the library <a href="https://github.com/com-lihaoyi/os-lib#cookbook">README Cookbook</a> and <a href="https://www.lihaoyi.com/post/HowtoworkwithFilesinScala.html">this article</a>
from Li Haoyi himself, check them out if you want to explore the
library, I couldn't find a lot of examples of its usages,
especially in a "real" situation. The library is a porting of
<a href="https://docs.python.org/3/library/os.html">Python's Os library</a> and there are examples of it around for sure,
but no one wants to have to translate from a language to another
when he is looking for examples.
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-" class="outline-3">
<h3 id="sec-">Insert Script Dependency</h3>
<div class="outline-text-3" id="text-">
<p>
The first thing you want to do is to add the <a href="https://github.com/com-lihaoyi/os-lib">os-lib</a> to your
<a href="https://scala-cli.virtuslab.org/">  scala-cli</a>. At the moment of writing the latest version is <code>0.8.1</code>.
Just add this snippet at the very top of your script
</p>

<div class="org-src-container">

<pre class="src src-scala"><span style="color: #ff7f24;">#!/usr/bin/env scala-cli</span>
<span style="color: #00ffff;">using</span> lib <span style="color: #ffa07a;">"com.lihaoyi::os-lib:0.8.1"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-" class="outline-3">
<h3 id="sec-">Movie Convertion Script</h3>
<div class="outline-text-3" id="text-">
</div><div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">File Paths</h4>
<div class="outline-text-4" id="text-">
<p>
Let's convert simple file path strings to the ones used by the
library. Note how I had to specify a temporary existing directory
for the script to work and store intermediate results. Meanwhile the
<a href="https://github.com/com-lihaoyi/os-lib/">os-lib</a> provides a <a href="https://github.com/com-lihaoyi/os-lib#ostempdir">temp dir</a> operation to get it.
</p>

<p>
I can then change the other paths as well to start straight away
from the <code>home directory</code>. This will make it more flexible since I
can easily move the script without having to update the paths.
</p>

<div class="org-src-container">

<pre class="src src-scala"><span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Before</span>
<span style="color: #00ffff;">val</span> <span style="color: #eedd82;">tempPath</span> <span style="color: #00ffff;">=</span> <span style="color: #ffa07a;">"/Users/benkio/temp"</span>
<span style="color: #00ffff;">val</span> <span style="color: #eedd82;">startingPath</span> <span style="color: #00ffff;">=</span> <span style="color: #ffa07a;">"/Users/benkio/temp/test"</span>
<span style="color: #00ffff;">val</span> <span style="color: #eedd82;">destinationPath</span> <span style="color: #00ffff;">=</span> <span style="color: #ffa07a;">"/Users/benkio/temp/convertedFilms"</span>

<span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">After</span>

<span style="color: #00ffff;">val</span> <span style="color: #eedd82;">tempPath</span> <span style="color: #00ffff;">=</span> os.temp.dir()
<span style="color: #00ffff;">val</span> <span style="color: #eedd82;">startingPath</span> <span style="color: #00ffff;">=</span> os.home/<span style="color: #ffa07a;">"temp"</span>/<span style="color: #ffa07a;">"test"</span>
<span style="color: #00ffff;">val</span> <span style="color: #eedd82;">destinationPath</span> <span style="color: #00ffff;">=</span> os.home/<span style="color: #ffa07a;">"temp"</span>/<span style="color: #ffa07a;">"convertedFilms"</span>
</pre>
</div>

<p>
Note: on the <a href="https://github.com/com-lihaoyi/os-lib#ospath">README os.Path section</a> you could find that you can
create a path using just the <code>'</code> prefix. However, if you try you
might get this error:
</p>

<pre class="example">
[error] ./convertFilms.sc:18:31: symbol literal 'temp is no longer supported,
[error] use a string literal "temp" or an application Symbol("temp") instead,
[error] or enclose in braces '{temp} if you want a quoted expression.
[error] For now, you can also `import language.deprecated.symbolLiterals` to accept
[error] the idiom, but this possibility might no longer be available in the future.
[error] val destinationPath = os.home/'temp/'convertedFilms
</pre>

<p>
That's why I ended up using simple strings.
</p>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">Script Entry Point</h4>
<div class="outline-text-4" id="text-">
<p>
In order to understand what this script is supposed to do, we need
to have a look at its entry point. This will now be effected by the
introduction of the <a href="https://github.com/com-lihaoyi/os-lib">os-lib</a>, but it will provide the context to
understand each step.
</p>

<div class="org-src-container">

<pre class="src src-scala"><span style="color: #00ffff;">val</span> <span style="color: #eedd82;">inputFiles</span><span style="color: #00ffff;">:</span> <span style="color: #98fb98;">List</span>[(<span style="color: #7fffd4;">String</span>, <span style="color: #7fffd4;">String</span>)] <span style="color: #00ffff;">=</span> <span style="color: #7fffd4;">List</span>(
  (<span style="color: #ffa07a;">"movie.avi"</span>, <span style="color: #ffa07a;">"movie"</span>),
  (<span style="color: #ffa07a;">"film.mkv"</span>, <span style="color: #ffa07a;">"film"</span>)
)

inputFiles.foreach { <span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">1</span>
  <span style="color: #00ffff;">case</span> (<span style="color: #eedd82;">inputFile</span>, <span style="color: #eedd82;">filename</span>) <span style="color: #00ffff;">=&gt;</span> {
    ffmpegCommand(inputFile, filename) <span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">2</span>
    splitCommand(filename)             <span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">3</span>
    removeCommand(filename)            <span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">4</span>
    moveCommand(filename)              <span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">5</span>
  }
}
</pre>
</div>

<p>
What it does is:
</p>
<ol class="org-ol">
<li>cycle through each pair in input where the first one is the
actual file to be converted and the second one is the output
filename without extension. For each pair this will:
</li>
<li>Run the ffmpeg command with the specific input to produce a video
compatible with the target TV: right bitrate, resolution, codec,
container, audio codec&#x2026;
</li>
<li>Split the result of the previous step in chunks of max 1GB.
</li>
<li>Remove the output of step 2. We are only interested in the chunks
from step 3.
</li>
<li>Move the chunks for the step 3 to the destination path.
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">FFMPEG Command</h4>
<div class="outline-text-4" id="text-">
<p>
Previously we just craft the command as a simple string with
interpolated input and run &amp; forget it with the <code>!</code>
command. Instead, the <a href="https://github.com/com-lihaoyi/os-lib">os-lib</a> provides a <a href="https://github.com/com-lihaoyi/os-lib#osproccall">os.call</a> that will run a
command <a href="https://javadoc.io/doc/com.lihaoyi/os-lib_3/latest/api/os/Shellable.html">Shellable</a> process synchronously.
</p>

<div class="org-src-container">

<pre class="src src-scala"><span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Before</span>
<span style="color: #00ffff;">def</span> <span style="color: #87cefa;">ffmpegCommand</span>(inputFile<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>, outputFilename<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">Unit</span> <span style="color: #00ffff;">=</span> {
  <span style="color: #00ffff;">val</span> <span style="color: #eedd82;">ffmpegCmd</span> <span style="color: #00ffff;">=</span>
    s<span style="color: #ffa07a;">"""ffmpeg -i "</span><span style="color: #eedd82;">$startingPath</span><span style="color: #ffa07a;">/</span><span style="color: #eedd82;">$inputFile</span><span style="color: #ffa07a;">" -c:v libxvid -b:v 1500k -c:a libmp3lame -qscale:a 4 -vf scale=720:-1 "</span><span style="color: #eedd82;">$tempPath</span><span style="color: #ffa07a;">/</span><span style="color: #eedd82;">$outputFilename</span><span style="color: #ffa07a;">.avi""""</span>
  ffmpegCmd !
}

<span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">After</span>
<span style="color: #00ffff;">def</span> <span style="color: #87cefa;">ffmpegCommand</span>(inputFile<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>, outputFilename<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">os</span>.<span style="color: #7fffd4;">CommandResult</span> <span style="color: #00ffff;">=</span>
  os.proc(
    <span style="color: #ffa07a;">"ffmpeg"</span>,
    <span style="color: #ffa07a;">"-i"</span>,
    startingPath / inputFile,
    <span style="color: #ffa07a;">"-c:v"</span>,
    <span style="color: #ffa07a;">"libxvid"</span>,
    <span style="color: #ffa07a;">"-b:v"</span>,
    <span style="color: #ffa07a;">"1500k"</span>,
    <span style="color: #ffa07a;">"-c:a"</span>,
    <span style="color: #ffa07a;">"libmp3lame"</span>,
    <span style="color: #ffa07a;">"-qscale:a"</span>,
    <span style="color: #ffa07a;">"4"</span>,
    <span style="color: #ffa07a;">"-vf"</span>,
    <span style="color: #ffa07a;">"scale=720:-1"</span>,
    tempPath / s<span style="color: #ffa07a;">"</span><span style="color: #eedd82;">$outputFilename</span><span style="color: #ffa07a;">.avi"</span>
  ).call()
</pre>
</div>

<p>
Another noticeable change here is the fact that we return a
<a href="https://javadoc.io/doc/com.lihaoyi/os-lib_3/latest/api/os/CommandResult.html">os.CommandResult</a> instead of <code>Unit</code>. This will be later used to check
the <code>exitcode</code> of the <code>ffmpeg</code> process.
</p>

<p>
<a id="spawn" name="spawn"></a>One could wonder why I didn't go for <a href="https://javadoc.io/doc/com.lihaoyi/os-lib_3/latest/api/os/proc.html">os.spawn</a> instead of <a href="https://javadoc.io/doc/com.lihaoyi/os-lib_3/latest/api/os/proc.html">os.call</a> in
order to take advantage of sub-processing and parallelise the whole
script. The issue here is that we don't know in advance how many
files we will have to convert. In the scenario where there are
several input files, having the <a href="https://javadoc.io/doc/com.lihaoyi/os-lib_3/latest/api/os/proc.html">os.spawn</a> will cause tons of
long-live ffmpeg sub-processes that will hang the whole system.
</p>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">Split Command</h4>
<div class="outline-text-4" id="text-">
<p>
The Split command still uses <code>ffmpeg</code> since we want these files to
be playable and <code>ffmpeg</code> guarantees to produce a video file. We
can't just split the bytes, you know. The idea here is to split by
time: 1 chunk per hour. We don't have a way to read the length of
the movie, but we can assume it will be at most 3 hours.
</p>

<p>
So, we can build a long command to do it. Again, converting it to
the new library will just be a long long call with quite some
parameters.
</p>

<div class="org-src-container">

<pre class="src src-scala"> <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Before</span>
 <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">splitCommand</span>(inputFilename<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">Unit</span> <span style="color: #00ffff;">=</span> {
  <span style="color: #00ffff;">val</span> <span style="color: #eedd82;">splitCmd</span> <span style="color: #00ffff;">=</span>
    s<span style="color: #ffa07a;">"""ffmpeg -v quiet -y -i "</span><span style="color: #eedd82;">$tempPath</span><span style="color: #ffa07a;">/</span><span style="color: #eedd82;">$inputFilename</span><span style="color: #ffa07a;">.avi" -vcodec copy -acodec copy -ss 00:00:00 -t 01:00:00 -sn "</span><span style="color: #eedd82;">$tempPath</span><span style="color: #ffa07a;">/</span><span style="color: #eedd82;">${inputFilename}</span><span style="color: #ffa07a;">_1.avi" -vcodec copy -acodec copy -ss 01:00:00 -t 01:00:00 -sn "</span><span style="color: #eedd82;">$tempPath</span><span style="color: #ffa07a;">/</span><span style="color: #eedd82;">${inputFilename}</span><span style="color: #ffa07a;">_2.avi" -vcodec copy -acodec copy -ss 02:00:00 -t 01:00:00 -sn "</span><span style="color: #eedd82;">$tempPath</span><span style="color: #ffa07a;">/</span><span style="color: #eedd82;">${inputFilename}</span><span style="color: #ffa07a;">_3.avi""""</span>
  splitCmd !
}

<span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">After</span>
<span style="color: #00ffff;">def</span> <span style="color: #87cefa;">splitCommand</span>(inputFilename<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">os</span>.<span style="color: #7fffd4;">CommandResult</span> <span style="color: #00ffff;">=</span>
  os.proc(
    <span style="color: #ffa07a;">"ffmpeg"</span>,
    <span style="color: #ffa07a;">"-v"</span>,
    <span style="color: #ffa07a;">"quiet"</span>,
    <span style="color: #ffa07a;">"-y"</span>,
    <span style="color: #ffa07a;">"-i"</span>,
    tempPath / <span style="color: #ffa07a;">"$inputFilename.avi"</span>,
    <span style="color: #ffa07a;">"-vcodec"</span>,
    <span style="color: #ffa07a;">"copy"</span>,
    <span style="color: #ffa07a;">"-acodec"</span>,
    <span style="color: #ffa07a;">"copy"</span>,
    <span style="color: #ffa07a;">"-ss"</span>,
    <span style="color: #ffa07a;">"00:00:00"</span>,
    <span style="color: #ffa07a;">"-t"</span>,
    <span style="color: #ffa07a;">"01:00:00"</span>,
    <span style="color: #ffa07a;">"-sn"</span>,
    tempPath / <span style="color: #ffa07a;">"${inputFilename}_1.avi"</span>,
    <span style="color: #ffa07a;">"-vcodec"</span>,
    <span style="color: #ffa07a;">"copy"</span>,
    <span style="color: #ffa07a;">"-acodec"</span>,
    <span style="color: #ffa07a;">"copy"</span>,
    <span style="color: #ffa07a;">"-ss"</span>,
    <span style="color: #ffa07a;">"01:00:00"</span>,
    <span style="color: #ffa07a;">"-t"</span>,
    <span style="color: #ffa07a;">"01:00:00"</span>,
    <span style="color: #ffa07a;">"-sn"</span>,
    tempPath / <span style="color: #ffa07a;">"${inputFilename}_2.avi"</span>,
    <span style="color: #ffa07a;">"-vcodec"</span>,
    <span style="color: #ffa07a;">"copy"</span>,
    <span style="color: #ffa07a;">"-acodec"</span>,
    <span style="color: #ffa07a;">"copy"</span>,
    <span style="color: #ffa07a;">"-ss"</span>,
    <span style="color: #ffa07a;">"02:00:00"</span>,
    <span style="color: #ffa07a;">"-t"</span>,
    <span style="color: #ffa07a;">"01:00:00"</span>,
    <span style="color: #ffa07a;">"-sn"</span>,
    tempPath / <span style="color: #ffa07a;">"${inputFilename}_3.avi"</span>
  ).call()
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">Remove Command</h4>
<div class="outline-text-4" id="text-">
<p>
The remove command is quite straight forward to translate to the new
library since it exposes a <a href="https://github.com/com-lihaoyi/os-lib#osremove">os.remove</a> that remove a file if exists.
</p>

<div class="org-src-container">

<pre class="src src-scala"><span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Before</span>
<span style="color: #00ffff;">def</span> <span style="color: #87cefa;">removeCommand</span>(inputFilename<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">Unit</span> <span style="color: #00ffff;">=</span> {
  <span style="color: #00ffff;">val</span> <span style="color: #eedd82;">removeCmd</span> <span style="color: #00ffff;">=</span> s<span style="color: #ffa07a;">"""rm "</span><span style="color: #eedd82;">$tempPath</span><span style="color: #ffa07a;">/</span><span style="color: #eedd82;">$inputFilename</span><span style="color: #ffa07a;">.avi""""</span>
  removeCmd !
}

<span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">After</span>
<span style="color: #00ffff;">def</span> <span style="color: #87cefa;">removeCommand</span>(inputFilename<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">Unit</span> <span style="color: #00ffff;">=</span>
  os.remove(tempPath/s<span style="color: #ffa07a;">"</span><span style="color: #eedd82;">$inputFilename</span><span style="color: #ffa07a;">.avi"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">List Files</h4>
<div class="outline-text-4" id="text-">
<p>
Right now, there is this function in the script:
</p>

<div class="org-src-container">

<pre class="src src-scala"><span style="color: #00ffff;">def</span> <span style="color: #87cefa;">getListOfFiles</span>(dir<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">File</span>, prefix<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">List</span>[<span style="color: #7fffd4;">File</span>] <span style="color: #00ffff;">=</span> {
dir.listFiles.filter(<span style="color: #00ffff;">_</span>.isFile).toList.filter { file <span style="color: #00ffff;">=&gt;</span>
    file.getName.startsWith(prefix)
  }
}
</pre>
</div>

<p>
Starting from a folder, This will just return a list of files with a
given prefix. Please close an eye on the double <code>filter</code> call.
</p>

<p>
I can now simply replace this using <code>os.list</code> and then filter the
results with the same <code>filter</code> used above.
</p>

<div class="org-src-container">

<pre class="src src-scala">os.list(tempPath).filter(p <span style="color: #00ffff;">=&gt;</span> os.isFile(p) &amp;&amp; p.last.startsWith(inputFilename))
</pre>
</div>
<p>
I want to underline this error message I got, really really nice!
</p>

<pre class="example">
value IsFile is not a member of os - did you mean os.isFile?
</pre>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">Move Files</h4>
<div class="outline-text-4" id="text-">
<p>
We can then move the files listed and filtered in the previous
section with just a simple <code>foreach</code> and the help of the
<code>os.move.into</code>.
</p>

<p>
Beware the semantic differences between the move operations since
they could remove everything from the destination before performing
the operation, eg <code>os.move.over</code>, or just fail if the destination
does not exsists, eg <code>os.move</code>
</p>

<p>
The result becomes:
</p>

<div class="org-src-container">

<pre class="src src-scala"><span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Before</span>
<span style="color: #00ffff;">def</span> <span style="color: #87cefa;">moveCommand</span>(inputFilename<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>)<span style="color: #00ffff;">:</span><span style="color: #98fb98;">Unit</span> <span style="color: #00ffff;">=</span> {
  <span style="color: #00ffff;">val</span> <span style="color: #eedd82;">filesToMove</span> <span style="color: #00ffff;">=</span> getListOfFiles(<span style="color: #00ffff;">new</span> <span style="color: #98fb98;">File</span>(tempPath), inputFilename)
  filesToMove.foreach { file <span style="color: #00ffff;">=&gt;</span>
    <span style="color: #00ffff;">val</span> <span style="color: #eedd82;">moveCmd</span> <span style="color: #00ffff;">=</span> s<span style="color: #ffa07a;">"""mv </span><span style="color: #eedd82;">$tempPath</span><span style="color: #ffa07a;">/</span><span style="color: #eedd82;">${file.getName}</span><span style="color: #ffa07a;"> "</span><span style="color: #eedd82;">$destinationPath</span><span style="color: #ffa07a;">/""""</span>
    moveCmd !
  }
}

<span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">After</span>
<span style="color: #00ffff;">def</span> <span style="color: #87cefa;">moveCommand</span>(inputFilename<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">String</span>)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">Unit</span> <span style="color: #00ffff;">=</span>
  os.list(tempPath)
    .filter(p <span style="color: #00ffff;">=&gt;</span> os.isFile(p) &amp;&amp; p.last.startsWith(inputFilename))
    .foreach(f <span style="color: #00ffff;">=&gt;</span> os.move.into(f, destinationPath))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">Final Cleanup</h4>
<div class="outline-text-4" id="text-">
<p>
Now we can finally remove the useless imports! We can get rid of:
</p>

<div class="org-src-container">

<pre class="src src-scala"><span style="color: #00ffff;">import</span> sys.process.<span style="color: #00ffff;">_</span>
<span style="color: #00ffff;">import</span> scala.language.postfixOps
<span style="color: #00ffff;">import</span> java.io.<span style="color: #7fffd4;">File</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">Parallel Collection</h4>
<div class="outline-text-4" id="text-">
<p>
We introduced the idea of parallelise the computation in <a href="#spawn">the ffmpeg
subsection</a> when we talked about <a href="https://javadoc.io/doc/com.lihaoyi/os-lib_3/latest/api/os/proc.html">os.spawn</a>, saying it's not convenient
at that point. However, we can do something using <a href="https://github.com/scala/scala-parallel-collections">parallel collections</a>.
</p>

<p>
Since everything starts with a <code>List</code>, we can just import the
<a href="https://github.com/scala/scala-parallel-collections">parallel collections</a> lib and import, then use the <code>par</code> method to
convert it to <code>ParSeq</code>. Moreover, we have to limit the amout of
parallelism and we can do it by creating and setting a
<code>ForkJoinPoll</code> manually as <a href="https://docs.scala-lang.org/overviews/parallel-collections/configuration.html">this documentation</a>.
</p>

<p>
Finally, we can check the exit code of important commands. Of course
this will not scale and it's ugly code: <code>foreach</code>, nested ifs,
<code>println</code>&#x2026; But we are still doing scripting here! ðŸ˜›
</p>

<p>
The final entry point looks like this:
</p>

<div class="org-src-container">

<pre class="src src-scala"><span style="color: #00ffff;">val</span> <span style="color: #eedd82;">inputFiles</span><span style="color: #00ffff;">:</span> <span style="color: #98fb98;">ParSeq</span>[(<span style="color: #7fffd4;">String</span>, <span style="color: #7fffd4;">String</span>)] <span style="color: #00ffff;">=</span> <span style="color: #7fffd4;">List</span>(
  (<span style="color: #ffa07a;">"movie.avi"</span>, <span style="color: #ffa07a;">"movie"</span>),
  (<span style="color: #ffa07a;">"film.avi"</span>, <span style="color: #ffa07a;">"film"</span>)
).par

<span style="color: #00ffff;">val</span> <span style="color: #eedd82;">forkJoinPool</span> <span style="color: #00ffff;">=</span> <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">java</span>.util.concurrent.<span style="color: #7fffd4;">ForkJoinPool</span>(<span style="color: #7fffd4;">2</span>)
inputFiles.tasksupport <span style="color: #00ffff;">=</span> <span style="color: #00ffff;">new</span> <span style="color: #98fb98;">ForkJoinTaskSupport</span>(forkJoinPool)

inputFiles.foreach {
  <span style="color: #00ffff;">case</span> (<span style="color: #eedd82;">inputFile</span>, <span style="color: #eedd82;">filename</span>) <span style="color: #00ffff;">=&gt;</span> {
    <span style="color: #00ffff;">val</span> <span style="color: #eedd82;">ffmpegExitCode</span> <span style="color: #00ffff;">=</span> ffmpegCommand(inputFile, filename).exitCode
    <span style="color: #00ffff;">if</span> (ffmpegExitCode == <span style="color: #7fffd4;">0</span>) {
      <span style="color: #00ffff;">val</span> <span style="color: #eedd82;">splitExitCode</span> <span style="color: #00ffff;">=</span> splitCommand(filename).exitCode
      <span style="color: #00ffff;">if</span> (splitExitCode == <span style="color: #7fffd4;">0</span>) moveCommand(filename)
      <span style="color: #00ffff;">else</span> println(s<span style="color: #ffa07a;">"split failed for </span><span style="color: #eedd82;">$filename</span><span style="color: #ffa07a;">"</span>)
    } <span style="color: #00ffff;">else</span> println(s<span style="color: #ffa07a;">"ffmpeg command failed for </span><span style="color: #eedd82;">$inputFile</span><span style="color: #ffa07a;">"</span>)
    removeCommand(filename)
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">Testing</h4>
<div class="outline-text-4" id="text-">
<p>
I just tried the script after the above changes and I discovered
that it just hang ðŸ˜¯ ðŸ¤•
</p>

<p>
After some <code>println</code> and debugging it turned out that the starting
paths defined at the beginning of the files didn't quite work as
expected: when I add an additional value with <code>path/file</code> to
construct the final path and then call <code>toString</code> inside a
<code>println</code> everything blocked somehow!! ðŸ’€
</p>

<p>
The solution was to convert the above paths to <code>def</code> and pass the
final file as input in other to build the file in place. Plus, I had
to drop the temporary directory in favour of an existing one for the
same reason above.
</p>

<p>
The final change is:
</p>

<p>
#+bengin<sub>src</sub> scala
def tempPath(inputFile:String) = os.home/"temp"<i>"test"/inputFile
def startingPath(inputFile:String): os.Path = os.home</i>"temp"<i>"test"/inputFile
val destinationPath = os.home</i>"temp"/"convertedFilms"
#+end<sub>src</sub>_
</p>

<p>
Maybe I did some error along the way? missing some import? I don't
know really. If you have more experience with the library, you can
find the final code in the <a href="#sec-">References</a> section.
</p>

<p>
Apart from this inconvenience, once it was fixed, the script worked
as expected: starting 2 <code>ffmpeg</code> processes in parallel for
conversion, executing the split and cleanup.
</p>

<p>
Side note: the little price for concurrency is the overlap of the
processes outputs as you might expect in a multithread program.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-" class="outline-3">
<h3 id="sec-">Youtube to GIF Script</h3>
</div>
<div id="outline-container-ArticleConclusions" class="outline-3">
<h3 id="ArticleConclusions"><a id="sec-" name="sec-"></a>Conclusions</h3>
<div class="outline-text-3" id="text-ArticleConclusions">
</div>
</div>

<div id="outline-container-sec-" class="outline-3">
<h3 id="sec-">References</h3>
<div class="outline-text-3" id="text-">
</div>
</div>
</div>
<div id="outline-container-ShareButtons" class="outline-2">
<h2 id="ShareButtons"><a id="sec-" name="sec-"></a>Share Buttons</h2>
<div class="outline-text-2" id="text-ShareButtons">
<!-- AddToAny BEGIN -->
<hr>
<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
<a class="a2a_dd" href="https://www.addtoany.com/share"></a>
<a class="a2a_button_facebook"></a>
<a class="a2a_button_twitter"></a>
<a class="a2a_button_whatsapp"></a>
<a class="a2a_button_telegram"></a>
<a class="a2a_button_linkedin"></a>
<a class="a2a_button_email"></a>
</div>
<script async src="https://static.addtoany.com/menu/page.js"></script>
<!-- AddToAny END -->

<script type="text/javascript">
$(function() {
  $('#text-table-of-contents > ul li').first().css("display", "none");
  $('#text-table-of-contents > ul li').last().css("display", "none");
  $('#table-of-contents').addClass("visible-lg")
});
</script>
</div>
</div>
</div></div></div>
</body>
</html>
