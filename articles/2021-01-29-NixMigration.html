<!doctype html>
<html lang="en">
<head>
<title>Time to Try Nix - A Weekend Experiment</title>
<!-- 2021-02-07 Sun 19:18 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="benkio">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style>body { margin-bottom: 0px; }</style><script>
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script><link rel="shortcut icon" href="../../images/favicon.ico" type="image/x-icon">
<link rel="icon" href="../../images/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link rel="stylesheet" href="../css/main.css">
<link rel="stylesheet" href="../css/blog.css">
<link rel="stylesheet" href="../css/article.css">
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-3 col-md-push-9"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#navbar">Blog</a></li>
<li><a href="#Article">Time to Try Nix - A Weekend Experiment</a>
<ul class="nav">
<li><a href="#ArticleAbstract">Abstract</a></li>
<li><a href="#ArticleContent">Content</a>
<ul class="nav">
<li><a href="#sec-">The Plan</a></li>
<li><a href="#sec-">First Impact</a>
<ul class="nav">
<li><a href="#sec-">NixOs and Home Manager</a></li>
</ul>
</li>
<li><a href="#sec-">Setup From existing Github Configuration</a></li>
<li><a href="#sec-">Provided Packages</a></li>
<li><a href="#sec-">The Unexpected</a></li>
<li><a href="#sec-">Developer Environment</a></li>
</ul>
</li>
<li><a href="#ArticleConclusions">Conclusions</a></li>
<li><a href="#sec-">References</a></li>
</ul>
</li>
<li><a href="#ShareButtons">Share Buttons</a></li>
</ul>
</div>
</nav>
</div><div class="col-md-9 col-md-pull-3"><h1 class="title">Time to Try Nix - A Weekend Experiment</h1>

<div id="outline-container-navbar" class="outline-2 text-center navbar navbar-inverse navbar-fixed-top">
<h2 id="navbar"><a id="sec-" name="sec-"></a>Blog</h2>
<div class="outline-text-2" id="text-navbar">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#collapsableNavbar">
  <span class="icon-bar"Article 6</span>
  <span class="icon-bar"></span>
  <span class="icon-bar"></span>
</button>
<a title="Home" href="../blog.html"><h1 id="navbarTitle" class="navbar-text">Blog</h1></a>
<div class="collapse navbar-collapse" id="collapsableNavbar">
  <ul class="nav navbar-nav">
    <li><a title="Home" href="../index.html"><i class="fas fa-home fa-3x" aria-hidden="true"></i></a></li>
    <li><a title="Article List" href="../articleList.html" class="navbar-text h3">Article List</a></li>
<li><a title="Book List" href="../bookList.html" class="navbar-text h3">Book List</a></li>
<li><a title="Album List" href="../albumList.html" class="navbar-text h3">Album List</a></li>
  </ul>
</div>
</div>
</div>

<div id="outline-container-Article" class="outline-2">
<h2 id="Article"><a id="sec-" name="sec-"></a>Time to Try Nix - A Weekend Experiment</h2>
<div class="outline-text-2" id="text-Article">
<p>
<b>Created: <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-01-29 Fri&gt;</span></span></b>
</p>
</div>
<div id="outline-container-ArticleAbstract" class="outline-3">
<h3 id="ArticleAbstract"><a id="sec-" name="sec-"></a>Abstract</h3>
<div class="outline-text-3" id="text-ArticleAbstract">
<p>
Since some time now I hear about the <a href="https://nixos.wiki/wiki/Main_Page">Nix package manager</a>: how it is
awesome, how it solves you all the configuration problems of this
world, how it will make you hardware agnostic. You can read all the
benefits of it all over the web. Then, as a software developer and a
curious nerd with his own configuration scripts and so on, I decided that's
time to give it a go.
</p>

<p>
In this article, I will describe the process, from being a complete
newbie, knowing nothing about it apart form the last paragraph, to set
up a configuration in a weekend.
</p>

<p>
Disclamer: you might have different needs from mine, but still I
think this could help someone else. So, let's get ready to rumble!!!
</p>
</div>
</div>

<div id="outline-container-ArticleContent" class="outline-3">
<h3 id="ArticleContent"><a id="sec-" name="sec-"></a>Content</h3>
<div class="outline-text-3" id="text-ArticleContent">
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">The Plan</h4>
<div class="outline-text-4" id="text-">
<p>
As a real professional, I must start with a tweet ðŸ˜‰
</p>

<figure>
<p><img src="./2021-01-29-NixMigration/The_Plan_Tweet.png" class="img-responsive" alt="The_Plan_Tweet.png">
</p>
<figcaption><span class="figure-number">Figure 1:</span> The Plan Tweet</figcaption>
</figure>

<p>
I skip the <code>Virtual Box</code> &amp; <code>Ubuntu Minimal</code> installation. I choose
Ubuntu minimal as a base since I want to really start from scratch
and try to setup also the window manager.
</p>

<p>
Another question I want to answer straight away is: <i>Why don't I
just start using <code>NixOs</code> instead?</i> Honestly, I don't have a strong
reason, I can say I want to start as minimal as possible and from a
thing I know. Plus, it should be quicker to set up a minimal
virtual machine rather then one with <code>NixOs</code>.
</p>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">First Impact</h4>
<div class="outline-text-4" id="text-">
<p>
The only word I can think of is: <b>overwhelming</b>, but not in a good
way. It has so much stuff that you, newcomer, will feel confused
and disoriented. You might thing Â«Oh, let's read the manual/guide
from the official siteÂ», well there are tons of stuff: the <code>Nix</code>
language, the <code>Nixos</code>, the different commands, multi-user setup,
profiles and much much more. The only thing I found useful was
how to install <code>Nix</code> and that's it.
</p>

<p>
What I'm searching is: how to setup my own configuration, then,
when the need arise, I will go and search how to create a Set or a
function with the <code>Nix</code> language. Instead, a lot of the guides
doesn't start from a simple plain configuration with, let's say, just
<code>wget</code> and <code>7zip</code>.
</p>

<p>
So, I kept reading and reading, landing finally on Reddit. They
suggest to take an existing configuration and start by modifying
that. I must say the majority of the guides are about <code>NixOs</code>
instead of just <code>Nix</code> on a non-NixOs distribution, like I'm trying to do.
</p>
</div>

<div id="outline-container-sec-" class="outline-5">
<h5 id="sec-">NixOs and Home Manager</h5>
<div class="outline-text-5" id="text-">
<p>
In the end, I discovered that, with <code>Nix</code> only, you can't
actually manage the whole system(or it's not straightforward at
least). In particular, I wasn't able to find a guide telling you
how to set up a proper script like you would with bash. Plus,
if you want to change some configuration apart from just
installing/uninstalling software, you need <code>NixOs</code>. That could be
installed by using the <a href="https://github.com/jeaye/nixos-in-place">nix-in-place script</a>, but, what it does is
to create an <span class="underline">alternative</span> root folder as you will just restart
in <code>NixOs</code> and moves everything you have to an <code>old-root</code> folder. I
don't think you want that, unless you just do it from the start
(and still I find it not very cool, let's say okayish).
</p>

<p>
After some more research, I found the <a href="https://github.com/nix-community/home-manager">Home Manager Package</a>. This
will extend the capabilities of <code>Nix</code> by far and let you manage
your home directory using <code>Nix</code>. I still don't know if this has the
same power of <code>NixOs</code>, but it seems the thing I want. Especially,
considering that I wish to be more OS independent as possible.
</p>

<p>
What you have to do is to create a <code>home.nix</code> into your
<code>$HOME/.config/nixpkgs/</code> and then run <code>home-manager switch</code>.
Checkout my <a href="https://github.com/benkio/nix-config/commit/378a70906e691d4bdf3892844740743716eef40f">Initial Commit</a>. If you want to check out the initial
reference script, you can find it <a href="https://gist.github.com/benkio/2d4346e5e02b85556b0e">here</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">Setup From existing Github Configuration</h4>
<div class="outline-text-4" id="text-">
<p>
As every Emacs user, I already have my Emacs configuration
jealously crafted and polished. Now, I don't want to restart from
scratch and specify all the packages I have and so on. Plus, I have
some custom <code>elisp</code> functions I wish to preserve. Fortunately,
<code>Nix</code> gives you a way to fetch something from Github using
<code>fetchFromGitHub</code> function. (<a href="https://nixos.org/manual/nixpkgs/stable/#sec-sources">Manual Section</a>)
</p>

<p>
So, the idea here is to:
</p>
<ul class="org-ul">
<li>Download your configuration from Github: provide the owner, repository,
reference to the specific commit or tag and hash SHA256 of the
resulting directory
</li>
<li>Tell <code>Nix</code> to copy it into the <code>$HOME/.emacs.d/</code> directory. I
can't move it since <code>Nix</code> stores immutable directories in his
store. Therefore, you must just make a copy to the desired
location. Fortunately the Emacs configuration, without compilation
packages is not that big.
</li>
<li>Setup the Emacs server hook. (Optional, advanced topic)
</li>
</ul>

<p>
And that should be it. I took <a href="https://github.com/NixOS/nixpkgs/issues/14277">this issue</a> as a reference.
<b>EDIT:</b> After a little bit more research I found this better
answer: <a href="https://discourse.nixos.org/t/home-manager-spacemacs/8033">emacs.d home-manager dot file(directory)</a>
</p>

<p>
This works, BUT!!! the result will be all symlinks to the <code>Nix</code>
store. Then, you can't actually change anything from the
configuration itself because <code>Nix</code> store immutable data. You
should change it somewhere else, commit, recalculate the
sha256&#x2026;a full-pain. Then, you have to put a simple shell snippet
to copy the source to the <code>$HOME/.emacs.d/</code> folder and change the
permissions in order to be able to change it.
</p>

<p>
Huge downside of using <code>fetchFromGitHub</code> is that it just download
the tarball and extract it's content. Therefore, your Emacs <code>.git</code>
folder is not downloaded and then, when you move it to the right
place with the shell snippet you don't have the git
repository. Now, you can decide to use <code>fetchGit</code> with the
option <code>leaveDotGit = true</code> to solve the issue, <b>but</b> remember
that <code>Nix</code> rely on sha256 and bring the <code>.git</code> folder down will
increase the probability of a mismatch!! (<a href="https://discourse.nixos.org/t/keep-git-folder-in-when-fetching-a-git-repo/8590/2">source</a>)
</p>

<p>
As a result, you will have your beloved <code>emacs.d</code> configuration
maintained in another repository. The only weirdness I noticed was
that the resulting <code>git</code> repository is set on a new branch called
<code>fetchgit</code>. What you have to do is to:
</p>
<ul class="org-ul">
<li>Setup the remote: <code>git add remote origin
      https://github.com/....</code>
</li>
<li>Create &amp; checkout a new branch from <code>master</code>.
</li>
<li>Delete the <code>fetchgit</code>.
</li>
</ul>

<p>
Now the question is: does in work consistently? Is it actually
reproducible? Future myself will tell.
</p>

<p>
<a href="https://github.com/benkio/nix-config/commit/6b2a31fafab4f9853f9ef9a87acbebbfa810eab1">emacs configuration commit</a>
</p>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">Provided Packages</h4>
<div class="outline-text-4" id="text-">
<p>
I must say the amount of available packages is huge: I found
(almost) all I needed straight out of the main channels. I had
some trouble installing the <code>amule</code> package due to a missing
library (<code>crypto++</code>) and the <code>home-manager build</code> became quite
slow checking the packages, but overall it went smoothly more then
expected.
</p>

<p>
<a href="https://github.com/benkio/nix-config/commit/ef67d992efe0f96840e16814fe669ebae8c2498d">add packages and todos to the home.nix</a>
</p>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">The Unexpected</h4>
<div class="outline-text-4" id="text-">
<p>
I added more packages, I added the keyboard configuration and so
on, then I looked into how to setup <code>I3</code> and <code>X11</code>. Well, as a result
I caused an infinite login loop, inserting <code>startx</code> into the
<code>.bash_profile</code>. Apparently it tried just to turn back to login
again!!
</p>

<p>
Well, I guess it's time to try to setup a new virtual machine then.
</p>

<p>
As you could imagine, setting up <code>X11</code> and <code>XOrg</code> is not that
straight forward as the other packages. The reason behind this is
because online you can find a lot of articles using <code>NixOs</code> that
provides a system layer, meanwhile in here I don't have that, I
need to setup everything into the <code>home-manager</code> that seems to
have a subset of the configurations you can specify in
<code>NixOs</code>.
</p>

<p>
For example, in the following pages all reference to the
<code>Nix</code> configurations in the <i>etc</i> folder:
</p>

<p>
<a href="http://wiki.haskell.org/Xmonad/Installing_xmonad#NixOS">XMonad NixOs Installation Page</a>
<a href="https://gvolpe.com/blog/xmonad-polybar-nixos/#xmonad">Gabriel Volpe's XMonad Configuration</a>
</p>

<p>
<b>edit:</b> I start thinking that, installing <code>XOrg</code> into <code>VirtualBox</code>
is not a wonderful Idea and it might just not work. I'm thinking
about creating a Virtual machine with a GUI in place. I know it's
a fallback from the initial plan, but I have to reduce the amount
of weirdness if I wish to proceed ðŸ˜ƒ
</p>

<p>
After tons of trials, finally, I have to give up on
setting the Window Manager. Basically, if you are using <code>NixOs</code> it
should be easy: you have your own <code>/etc/nixos/configuration.nix</code>
where you set your system configuration and then, on
<code>$HOME/.config/nixos/home.nix</code> you can enable thing on the user
side easily. The problem here is that you are bound to
<code>NixOs</code>. You can install it with <code>nix-in-place</code>, but in my
mind you should be able to <b>CONFIGURE</b> everything you want without
having to go into the specific Linux distribution.
</p>

<p>
I might ask for help in the future into some IRC channel or wherever.
</p>
</div>
</div>

<div id="outline-container-sec-" class="outline-4">
<h4 id="sec-">Developer Environment</h4>
<div class="outline-text-4" id="text-">
<p>
After the failure of the previous section I decided that I can
live without setting my window manager for now (<a href="http://read.gov/aesop/005.html">The Fox &amp; The
Grapes</a>), what about <code>Scala</code> and <code>Haskell</code> then? Well, guess what, I
cloned a bunch of project in both languages and I wasn't able to
compile them in the virtual machine.
</p>

<dl class="org-dl">
<dt> Sbt </dt><dd></dd>
</dl>
<pre class="example">
MissingRequirementError: Object java.lang.object
in compiler mirror not found
</pre>
<dl class="org-dl">
<dt> Stack </dt><dd><code>libgmp.10.so: cannot open shared open file</code>
</dd>
</dl>

<p>
For both this errors I scanned the internet for HOURS without any
success. After all this pain, I'm really considering to just have
an additional shell script to run post-Nix. At least I can get
what I can't set from <code>Nix</code>&#x2026;if I just don't consider the whole
experiment a failure, but definitely it is not going the way I was
hoping for. Especially considering that I could just
install the <code>haskell-plaftorm</code> with a one-liner command.
</p>
</div>
</div>
</div>

<div id="outline-container-ArticleConclusions" class="outline-3">
<h3 id="ArticleConclusions"><a id="sec-" name="sec-"></a>Conclusions</h3>
<div class="outline-text-3" id="text-ArticleConclusions">

<figure>
<p><img src="./2021-01-29-NixMigration/weekendResult.png" class="img-responsive" alt="weekendResult.png">
</p>
<figcaption><span class="figure-number">Figure 2:</span> Weekend Recap</figcaption>
</figure>

<p>
Well, this is the final result. Not that great. What I could try to
do is to actually use directly <code>NixOs</code> and get away with it, but
who knows.
</p>

<p>
I know you want me to answer the questions:
</p>
<ul class="org-ul">
<li>Is it hard? Yes, as every time you need to work with a new
technology I guess. You need to learn a new language, a new way of
dealing with software and basically google for everything hoping
it's not a pain in the nuts&#x2026;being often disappointed&#x2026;
</li>
<li>Do you recommend it? Mmm hard to say, I did it since I'm a nerd
and I like to try stuff out when I hear/read good things about them,
but it's really worth it? Isn't just better to create your docker
image and live with it? Is actually better then a well crafted
script? Very hard to say, but I mean: I use Emacs, I have a blog
in org-mode. It's obvious that there is already something wrong
here. Probably, you should consider how important is for you to
have a really stable environment (more than bash script) and how
frequently you have to setup a new machine as well!
</li>
<li>When this could be convenient? I think, using <code>Nix</code> +
<code>home-manager</code> without <code>NixOs</code>, could be convenient when you don't
care/want/can manage the operating system settings, eg. some
developers set up their MacOs using <code>Nix</code> instead of <code>Homebrew</code>.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-" class="outline-3">
<h3 id="sec-">References</h3>
<div class="outline-text-3" id="text-">
<dl class="org-dl">
<dt> <a href="https://nixos.org/">NixOs Website</a> </dt><dd>Where you can find all the official instructions
about <code>Nix</code> and the related distribution.
</dd>
<dt> <a href="https://github.com/jeaye/nixos-in-place">Nix In Place</a> </dt><dd>You can install <code>NixOs</code> wherever you want (Linux or
Mac) more or less.
</dd>
<dt> <a href="https://github.com/nix-community/home-manager">Home Manager</a> </dt><dd><code>Nix</code> package that allows you to access quite some
configuration options of your home directory as well as manage
your software.
</dd>
<dt> <a href="https://github.com/benkio/nix-config.git">My Nix Configuration</a> </dt><dd>Here is where I try to build my nix
configuration.
</dd>
<dt> <a href="https://gist.github.com/benkio/2d4346e5e02b85556b0e">Reference Script</a> </dt><dd>Script I used until now to setup a new machine
</dd>
</dl>
</div>
</div>
</div>
<div id="outline-container-ShareButtons" class="outline-2">
<h2 id="ShareButtons"><a id="sec-" name="sec-"></a>Share Buttons</h2>
<div class="outline-text-2" id="text-ShareButtons">
<!-- AddToAny BEGIN -->
<hr>
<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
<a class="a2a_dd" href="https://www.addtoany.com/share"></a>
<a class="a2a_button_facebook"></a>
<a class="a2a_button_twitter"></a>
<a class="a2a_button_whatsapp"></a>
<a class="a2a_button_telegram"></a>
<a class="a2a_button_linkedin"></a>
<a class="a2a_button_email"></a>
</div>
<script async src="https://static.addtoany.com/menu/page.js"></script>
<!-- AddToAny END -->

<script type="text/javascript">
$(function() {
  $('#text-table-of-contents > ul li').first().css("display", "none");
  $('#text-table-of-contents > ul li').last().css("display", "none");
  $('#table-of-contents').addClass("visible-lg")
});
</script>
</div>
</div>
</div></div></div>
</body>
</html>
