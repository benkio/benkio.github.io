<!doctype html>
<html lang="en">
<head>
<title>Gilded Rose Kata</title>
<!-- 2020-07-02 Thu 22:24 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style>body { margin-bottom: 0px; }</style><script>
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script><link rel="shortcut icon" href="../../images/favicon.ico" type="image/x-icon">
<link rel="icon" href="../../images/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="../css/main.css">
<link rel="stylesheet" href="../css/blog.css">
<link rel="stylesheet" href="../css/article.css">
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-3 col-md-push-9"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#navbar">Blog</a></li>
<li><a href="#Article">Gilded Rose Kata</a>
<ul class="nav">
<li><a href="#ArticleAbstract">Abstract</a></li>
<li><a href="#ArticleContent">Content</a>
<ul class="nav">
<li><a href="#CodebaseStateContent">Codebase State</a></li>
<li><a href="#SolutionApproachContent">Solution Approach</a>
<ul class="nav">
<li><a href="#SolutionApproachTestsContent">Tests</a></li>
<li><a href="#SolutionApproachSplitMonsterContent">Split the Monster</a></li>
<li><a href="#SolutionApproachMutationContent">Dealing With Mutation once and for All</a></li>
<li><a href="#sec-">Refinement</a></li>
</ul>
</li>
<li><a href="#ScalaContent">Scala Kata</a></li>
<li><a href="#HaskellContent">Haskell Kata</a></li>
</ul>
</li>
<li><a href="#ArticleConclusions">Conclusions</a>
<ul class="nav">
<li><a href="#MainChallengesConclusion">Main Challenges</a></li>
<li><a href="#LaguagesComparisonConclusions">Languages Comparison</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ShareButtons">Share Buttons</a></li>
</ul>
</div>
</nav>
</div><div class="col-md-9 col-md-pull-3"><h1 class="title">Gilded Rose Kata</h1>

<div id="outline-container-navbar" class="outline-2 text-center navbar navbar-inverse navbar-fixed-top">
<h2 id="navbar"><a id="sec-" name="sec-"></a>Blog</h2>
<div class="outline-text-2" id="text-navbar">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#collapsableNavbar">
  <span class="icon-bar"Article 6</span>
  <span class="icon-bar"></span>
  <span class="icon-bar"></span>
</button>
<a title="Home" href="../blog.html"><h1 id="navbarTitle" class="navbar-text">Blog</h1></a>
<div class="collapse navbar-collapse" id="collapsableNavbar">
  <ul class="nav navbar-nav">
    <li><a title="Home" href="../index.html"><i class="fas fa-home fa-3x" aria-hidden="true"></i></a></li>
    <li><a title="Article List" href="../articleList.html" class="navbar-text h3">Article List</a></li>
<li><a title="Book List" href="../bookList.html" class="navbar-text h3">Book List</a></li>
<li><a title="Album List" href="../albumList.html" class="navbar-text h3">Album List</a></li>
  </ul>
</div>
</div>
</div>

<div id="outline-container-Article" class="outline-2">
<h2 id="Article"><a id="sec-" name="sec-"></a>Gilded Rose Kata</h2>
<div class="outline-text-2" id="text-Article">
<p>
<b>Created: <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-06-30 Tue&gt;</span></span></b>
</p>
</div>
<div id="outline-container-ArticleAbstract" class="outline-3">
<h3 id="ArticleAbstract"><a id="sec-" name="sec-"></a>Abstract</h3>
<div class="outline-text-3" id="text-ArticleAbstract">
<p>
Not some time ago I watched the mighty <a href="https://twitter.com/NicolasRinaudo">Nicolas Rinaudo</a> dealing with
the <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata">Gilded Rose Kata</a> on the <a href="https://www.twitch.tv/scalalove">scalalove's twitch channel</a> and that
inspired me into trying it out using my favorite languages: Scala &amp;
Haskell.
</p>

<p>
I'll structure the article in this way:
</p>
<ol class="org-ol">
<li>I want to get familiar with the actual code-base, analyze it and
explain what are the (main) flaws I can see. This section will be
language-independent, since the same algorithm will be
implemented in the same way, no matter the language, by kata's
definition. It's a refactoring kata after all.
</li>
<li>Following the previous point, I will write down the approach I'll
use. This should be language-independent as well
</li>
<li>Then, It's time to point out the difficulties I found into doing
it with Scala and Haskell, the pros and cons. I could try also to
do a comparison between the two.
</li>
</ol>
</div>
</div>

<div id="outline-container-ArticleContent" class="outline-3">
<h3 id="ArticleContent"><a id="sec-" name="sec-"></a>Content</h3>
<div class="outline-text-3" id="text-ArticleContent">
</div>

<div id="outline-container-CodebaseStateContent" class="outline-4">
<h4 id="CodebaseStateContent"><a id="sec-" name="sec-"></a>Codebase State</h4>
<div class="outline-text-4" id="text-CodebaseStateContent">
<p>
In order to write this section, I just need to access the <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata">Github kata
repo</a> and do the most boring thing I usually do, after meetings: a
code review.
</p>

<p>
<b>Disclaimer:</b> this code is intentionally bad. If you will ever
encounter a code-base like this one in your life, listen to me&#x2026;
</p>

<iframe src="https://giphy.com/embed/A6PcmRqkyMOBy" width="480" height="224" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>

<p>
let's start&#x2026;
</p>

<p>
First thing first, I see there are no tests for the
application. That needs to be fixed ASAP. We will talk about that in
the <a href="#SolutionApproachTestsContent">specific section</a>.
</p>

<p>
Then I see an attempt of a <i><a href="https://en.wikipedia.org/wiki/Domain_model">Domain Model</a></i>. That's actually a good
practice: design your types first and be as picky as possible in
order to <a href="https://fsharpforfunandprofit.com/posts/designing-with-types-making-illegal-states-unrepresentable/">make the illegal states unrepresentable</a>. The problems here
are
</p>
<ul class="org-ul">
<li>The <code>var</code> keyword, that means mutability. As an FP enthusiast, I
know mutable state can be hard to manage and lead to unintended
behaviors. I just notice how it's a problem with the Scala solution
only! Mutation is possible in Haskell too, but luckily we got
spared.
</li>
<li>Just Items!! There are two possible cases: the problem is
extremely simple or we are missing some types here.
</li>
<li>No validations. I expect to see some data validation to ensure the
values we are going to compute remains valid throughout the program
execution.
</li>
</ul>

<p>
Finally, it comes to the main algorithm and It has several problems as expected:
</p>
<ol class="org-ol">
<li>There's only one giant function. Ok, that in the end the CPU will
execute 1 operation at a time(mono-core, single-thread), but code
needs to be human-readable. <i>Any fool can write code that a computer can understand. Good programmers write code that humans can understand.</i> (Martin Fowler)
Plus it violates the <a href="https://en.wikipedia.org/wiki/Single-responsibility_principle">Single Responsibility Principle</a>.
</li>
<li>Mutation again! Apart from the items fields, that was expected,
also into the index variable <code>i</code>. Luckily, it is just used to
select the current element to evaluate, it could be way worse,
like a different algorithm for odd and even elements, checks on
the index, and so on.
</li>
<li>There should be Types and a compiler somewhere, but I don't see
any usage of those in here. The code is nearly indistinguishable
from Javascript.
</li>
<li>Nested Ifs statements.
</li>
</ol>
</div>
</div>

<div id="outline-container-SolutionApproachContent" class="outline-4">
<h4 id="SolutionApproachContent"><a id="sec-" name="sec-"></a>Solution Approach</h4>
<div class="outline-text-4" id="text-SolutionApproachContent">
<p>
Following up on the previous analysis, we can come up with a plan and
here I'll prioritize the tasks we need to do in order to make
this code better and solve the kata.
</p>
</div>

<div id="outline-container-SolutionApproachTestsContent" class="outline-5">
<h5 id="SolutionApproachTestsContent"><a id="sec-" name="sec-"></a>Tests</h5>
<div class="outline-text-5" id="text-SolutionApproachTestsContent">
<p>
The first task needed is a good test suite. With proper testing we
will be sure that the changes we are going to make are
correct. After all, the definition of <i><a href="https://en.wikipedia.org/wiki/Code_refactoring">Code Refactoring</a></i> is to <b>NOT</b>
change the program behavior.
</p>

<p>
Now, the test suite can be crafted using multiple techniques and it's a
huge topic by itself. In this case, testing is not the main focus of
the kata but still key. Fortunately, it's a simple, little, local
program. So we should be fine with just <i><a href="https://en.wikipedia.org/wiki/Unit_testing">Unit Testing</a></i> and <i><a href="https://en.wikipedia.org/wiki/System_testing">System Testing</a></i>.
</p>

<p>
Usually, testing is done by providing some specific input data to
the program, fetch the result of the computation, and then compare
it with what is expected. That's completely fine and it's what the
majority of the companies do nowadays. The downside of this approach
is it's static: let say your program has a bug, or crash, for a
corner case you didn't thought about, testing by example will not
help you there.
</p>

<p>
A different approach I like more is <a href="https://en.wikipedia.org/wiki/Property_testing">Property Testing</a>, where the
input data is <b>generated</b>. The software engineer defines the rules
used by the supporting library/framework to generate the inputs and
then the expected behavior as a property. I won't go deeper into it,
but the typical example is the associativity of the sum
operation. Definitely, the most complicated part is to identify the
properties of your program, but in my honest opinion, I still see
benefits into just take advantage of the generated inputs. For
instance, you will write your test once and it will run multiple
times with several inputs. It's straight away a big plus.
</p>

<p>
Another downside of this approach is the computational cost:
generating inputs and having multiple runs will increase the testing time.
</p>

<p>
<b><b>Edit:</b></b> Since we have even the specs of the program the
property base testing fits super nicely: convert phrases like
</p>

<p>
<i>“Sulfuras”, being a legendary item, never has to be sold or
decreases in Quality</i>
</p>

<p>
becomes quite a natural process.
</p>
</div>
</div>

<div id="outline-container-SolutionApproachSplitMonsterContent" class="outline-5">
<h5 id="SolutionApproachSplitMonsterContent"><a id="sec-" name="sec-"></a>Split the Monster</h5>
<div class="outline-text-5" id="text-SolutionApproachSplitMonsterContent">
<p>
Once we have the testing set up properly, we can start to break
stuff using the 🔨.
</p>

<p>
The Most annoying thing in the codebase is the giant
stand-alone function. I will tackle this by splitting that
function into two or more sub-functions. Then, repeat the same
approach for the outcoming functions. This recursive process
will terminate when the functions I end up with have a small
number of lines of code and one single mutation in it, simple as
that.
</p>

<p>
A little but key detail in all of this is that each function will
return a value and the parent function will be a composition of
its child.
</p>

<p>
This works well when you have 2 consecutive if-statements or an
if-else-statement:
</p>

<div class="org-src-container">

<pre class="src src-scala"><span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Before</span>
<span style="color: #00ffff;">if</span> (condition1) {
  <span style="color: #00ffff;">if</span> (condition3) {
   <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Stuff</span>
  } <span style="color: #00ffff;">else</span> <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Stuff</span>
}
<span style="color: #00ffff;">if</span> (condition2) {
<span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Stuff</span>
} <span style="color: #00ffff;">else</span> <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Stuff</span>

<span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">After</span>
<span style="color: #00ffff;">def</span> <span style="color: #87cefa;">f1</span>(params)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">StuffType</span> <span style="color: #00ffff;">=</span> <span style="color: #00ffff;">if</span> (condition1) { f3(params) } <span style="color: #00ffff;">else</span> <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Previous state (identity)</span>
<span style="color: #00ffff;">def</span> <span style="color: #87cefa;">f2</span>(params)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">StuffType</span> <span style="color: #00ffff;">=</span> <span style="color: #00ffff;">if</span> (condition2) {<span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">Stuff */</span> } <span style="color: #00ffff;">else</span> <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Stuff</span>
<span style="color: #00ffff;">def</span> <span style="color: #87cefa;">f3</span>(params)<span style="color: #00ffff;">:</span> <span style="color: #98fb98;">StuffType</span> <span style="color: #00ffff;">=</span> <span style="color: #00ffff;">if</span> (condition3) {<span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">Stuff */</span> } <span style="color: #00ffff;">else</span> <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Stuff</span>
<span style="color: #00ffff;">val</span> <span style="color: #eedd82;">r1</span> <span style="color: #00ffff;">=</span> f1(args)
<span style="color: #00ffff;">val</span> <span style="color: #eedd82;">r2</span> <span style="color: #00ffff;">=</span> f2(args) <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">This might probably require r1 as input</span>
r2
</pre>
</div>

<p>
This might seems controversial and more complicated, but it helps
in to put the computations in context. This way, you don't need to
go and look into the content of the functions, you can just skip
their implementation details and get an overall feeling of the
data-flow. Plus, you could not realize it yet, but doing so we
also put types back into play!
</p>

<p>
You might also notice I added an else to the first if, that's
because I want the wrapping function to actually return a type
and, since there wasn't an else, in that case, the result will be
the previous input. When the else branch is chosen the <code>f1</code>
function will behave as the <a href="https://en.wikipedia.org/wiki/Identity_function">Identity Function</a>.
</p>

<p>
In the very end, I want also to grab your attention on the way
this approach penetrates the nested ifs and allow us to collapse the
structure. Of course, we could also merge <code>condition1</code> and
<code>condition3</code>, and we might actually decide to do that in a later
stage, but let us suppose we will discover that the same logic of
<code>f3</code> is reused. This way we can just call <code>f3</code> since it's independent.
</p>
</div>
</div>

<div id="outline-container-SolutionApproachMutationContent" class="outline-5">
<h5 id="SolutionApproachMutationContent"><a id="sec-" name="sec-"></a>Dealing With Mutation once and for All</h5>
<div class="outline-text-5" id="text-SolutionApproachMutationContent">
<p>
Everything is in its own box that returns a new version of the
input 💜, However&#x2026; it still mutates and internal field!! But
because we are in this situation we can easily remove that
mutation and from the model itself and return a new copy of the
input with the requested changes.
</p>

<p>
<b><b>Edit:</b></b> Reading the specification I'm not allow to touch the
  Item class unfortunately. Then, this step will remain
  theoretic, for Scala at least.
</p>
</div>
</div>
<div id="outline-container-sec-" class="outline-5">
<h5 id="sec-">Refinement</h5>
<div class="outline-text-5" id="text-">
<p>
Finally, with this new working codebase, we should be able to see
patterns clearly and apply further optimizations. In particular,
regarding:
</p>
<ul class="org-ul">
<li>Merging condition together
</li>
<li>Adding fields validation
</li>
<li>Structuring the code: moving the functions to the model companion
objects, in case of Scala, or to a separate module.
</li>
</ul>

<p>
Now that we have a plan, let's start the fun part&#x2026;let's
executed it!
</p>
</div>
</div>
</div>

<div id="outline-container-ScalaContent" class="outline-4">
<h4 id="ScalaContent"><a id="sec-" name="sec-"></a>Scala Kata</h4>
<div class="outline-text-4" id="text-ScalaContent">
<p>
<span class="timestamp-wrapper"><span class="timestamp">&lt;2020-07-02 Thu&gt;</span></span>: Started the scala exercise from testing and
<a href="https://www.scalacheck.org/">scalacheck</a>. Get stucked on some test corner case, but with some
<code>println</code> I figured it out. <a href="https://github.com/benkio/GeneralExercises/commit/8e066e5cc678518f6f10147f7280969dce245be2">commit</a>
</p>
</div>
</div>

<div id="outline-container-HaskellContent" class="outline-4">
<h4 id="HaskellContent"><a id="sec-" name="sec-"></a>Haskell Kata</h4>
<div class="outline-text-4" id="text-HaskellContent">
</div>
</div>
</div>

<div id="outline-container-ArticleConclusions" class="outline-3">
<h3 id="ArticleConclusions"><a id="sec-" name="sec-"></a>Conclusions</h3>
<div class="outline-text-3" id="text-ArticleConclusions">
</div>

<div id="outline-container-MainChallengesConclusion" class="outline-4">
<h4 id="MainChallengesConclusion"><a id="sec-" name="sec-"></a>Main Challenges</h4>
<div class="outline-text-4" id="text-MainChallengesConclusion">
</div>
</div>


<div id="outline-container-LaguagesComparisonConclusions" class="outline-4">
<h4 id="LaguagesComparisonConclusions"><a id="sec-" name="sec-"></a>Languages Comparison</h4>
<div class="outline-text-4" id="text-LaguagesComparisonConclusions">
</div>
</div>
</div>
</div>

<div id="outline-container-ShareButtons" class="outline-2">
<h2 id="ShareButtons"><a id="sec-" name="sec-"></a>Share Buttons</h2>
<div class="outline-text-2" id="text-ShareButtons">
<!-- AddToAny BEGIN -->
<hr>
<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
<a class="a2a_dd" href="https://www.addtoany.com/share"></a>
<a class="a2a_button_facebook"></a>
<a class="a2a_button_twitter"></a>
<a class="a2a_button_whatsapp"></a>
<a class="a2a_button_telegram"></a>
<a class="a2a_button_linkedin"></a>
<a class="a2a_button_email"></a>
</div>
<script async src="https://static.addtoany.com/menu/page.js"></script>
<!-- AddToAny END -->

<script type="text/javascript">
$(function() {
  $('#text-table-of-contents > ul li').first().css("display", "none");
  $('#text-table-of-contents > ul li').last().css("display", "none");
  $('#table-of-contents').addClass("visible-lg")
});
</script>
</div>
</div>
</div></div></div>
</body>
</html>
